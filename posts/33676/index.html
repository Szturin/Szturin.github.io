<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【Tensorflow】[1]配置Tensorflow-GPU的快速模型训练 | Turin's Blog</title><meta name="author" content="Szturin"><meta name="copyright" content="Szturin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="author: sz_jmu  前言 TensorFlow 是一个用于机器学习和深度学习的开源框架，由 Google Brain 团队开发并在 2015 年发布。它是目前最流行的深度学习框架之一，广泛用于构建、训练和部署机器学习模型，特别是在处理复杂的神经网络任务时。TensorFlow 提供了灵活的工具和库，支持从研究到生产环境中的机器学习应用。 TensorFlow可以支持CPU，也可以支持C">
<meta property="og:type" content="article">
<meta property="og:title" content="【Tensorflow】[1]配置Tensorflow-GPU的快速模型训练">
<meta property="og:url" content="https://szturin.github.io/posts/33676/index.html">
<meta property="og:site_name" content="Turin&#39;s Blog">
<meta property="og:description" content="author: sz_jmu  前言 TensorFlow 是一个用于机器学习和深度学习的开源框架，由 Google Brain 团队开发并在 2015 年发布。它是目前最流行的深度学习框架之一，广泛用于构建、训练和部署机器学习模型，特别是在处理复杂的神经网络任务时。TensorFlow 提供了灵活的工具和库，支持从研究到生产环境中的机器学习应用。 TensorFlow可以支持CPU，也可以支持C">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://api.aqcoder.cn/random">
<meta property="article:published_time" content="2024-08-11T16:11:53.000Z">
<meta property="article:modified_time" content="2024-09-07T17:04:52.217Z">
<meta property="article:author" content="Szturin">
<meta property="article:tag" content="算法 计算机语言 机器人 单片机 EDA 电子技术学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://api.aqcoder.cn/random"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://szturin.github.io/posts/33676/index.html"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【Tensorflow】[1]配置Tensorflow-GPU的快速模型训练',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-08 01:04:52'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Turin's Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/share/"><i class="fa-fw fa fa-share-alt-square"></i><span> 分享</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/notebook/"><i class="fa-fw comment-alt-smile"></i><span> 笔记</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://api.aqcoder.cn/random')"><nav id="nav"><span id="blog-info"><a href="/" title="Turin's Blog"><span class="site-name">Turin's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-bookmark"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/share/"><i class="fa-fw fa fa-share-alt-square"></i><span> 分享</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/notebook/"><i class="fa-fw comment-alt-smile"></i><span> 笔记</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【Tensorflow】[1]配置Tensorflow-GPU的快速模型训练<a class="post-edit-link" href="null_posts/【Tensorflow】-1-配置Tensorflow-GPU的快速模型训练.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-11T16:11:53.000Z" title="发表于 2024-08-12 00:11:53">2024-08-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-07T17:04:52.217Z" title="更新于 2024-09-08 01:04:52">2024-09-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="【Tensorflow】[1]配置Tensorflow-GPU的快速模型训练"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>author: sz_jmu</p>
<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1>
<p>TensorFlow 是一个用于机器学习和深度学习的开源框架，由 Google Brain 团队开发并在 2015 年发布。它是目前最流行的深度学习框架之一，广泛用于构建、训练和部署机器学习模型，特别是在处理复杂的神经网络任务时。TensorFlow 提供了灵活的工具和库，支持从研究到生产环境中的机器学习应用。</p>
<p>TensorFlow可以支持CPU，也可以支持CPU+GPU，前者配置较为简单，兼容性较好，后者需要一些额外的操作支持。</p>
<p>在训练规模庞大的模型时，使用CPU往往存在较大的性能限制，模型训练速度较慢。神经网络算法通常涉及大量的参数、激活值、梯度值的缓冲区，其中每个值在每一次训练迭代中国都要被完全更新，有可能会超出传统计算机的高速缓存（Cache），所以内存带宽通常会成为主要瓶颈。而与CPU相比，GPU的一个显著优势就是具有极高的内存带宽。神经网络的训练算法通常不涉及大量的分支运算和复杂控制指令，更适合在GPU硬件上完成，具有并行特性的GPU更适合神经网络的计算，因此，安装TensorFlow的GPU环境是合适的选择。</p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Sciws/article/details/125290718">解决tensorflow-gpu版本训练loss一直为nan，或者loss，accuracy数值明显不对问题_采用gpu训练 loss为负数 采用cpu训练正常-CSDN博客</a></p>
<p>注意：配置Tensorflow gpu版本，建议使用Anoconda创建环境，避免出现污染环境变量等问题，Anoconda的配置与使用，不做过多赘述。</p>
<h1 id="一-tensorflow环境的基本配置"><a class="markdownIt-Anchor" href="#一-tensorflow环境的基本配置"></a> 一、Tensorflow环境的基本配置</h1>
<p>Tensorflow的GPU环境，在不同的系统下配置存在一些兼容性问题，如果直接安装最新的版本，很难完成通过GPU进行深度学习相关的环境搭建。</p>
<p>CUDA,cuDNN,python,tensorflow的版本需要一一对应。</p>
<p>使用如：python=3.8 CUDA=11.3 cuDNN=8.2.1 tensorflow-gpu=2.7.0，运行较为稳定。</p>
<p><strong>在Anoconda命令行环境下，创建Tensorflow的专属环境</strong>。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n tf_gpu_1 python==<span class="number">3.8</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>诸如CSDN等网站，许多参考文章说明要从Nivida官网安装CUDA，比较耗时麻烦，实际上tensorflow需要的是CUDA中的cudatoolkit，所以在Anoconda环境下进行如下安装操作即可：</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install cudatoolkit=<span class="number">11.3</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>安装cudnn,实际上作用是CUDA的补丁包</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install cudnn=<span class="number">8.2</span><span class="number">.1</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>安装tensorflow-gpu版本</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install tensorflow-gpu=<span class="number">2.7</span><span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>安装完成后，在tf_gpu_1环境中，检查是否能够查找到显卡驱动</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nivida-smi</span><br></pre></td></tr></tbody></table></figure>
<p><strong>检查tensorflow是否识别到GPU设备</strong></p>
<p>1.进入python命令行环境</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python</span><br></pre></td></tr></tbody></table></figure>
<p>2.导入tensorflow库</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre></td></tr></tbody></table></figure>
<p>3.是否查找到GPU设备</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"是否有 GPU 设备:"</span>, <span class="built_in">len</span>(tf.config.list_physical_devices(<span class="string">'GPU'</span>)) &gt; <span class="number">0</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>如果tensorflow环境配置正常，能够正常识别到主机GPU，tensorflow深度学习框架基本搭建完成，由于此例使用的tensorflow和python版本不是当前最高版本，后续自行编写相关代码可能需要根据具体的情况安装更多的依赖包或对代码进行调整。</p>
<h1 id="二-手写汉字识别神经网络模型训练"><a class="markdownIt-Anchor" href="#二-手写汉字识别神经网络模型训练"></a> 二、手写汉字识别神经网络模型训练</h1>
<h2 id="1数据集的准备"><a class="markdownIt-Anchor" href="#1数据集的准备"></a> 1.数据集的准备</h2>
<p>要实现手写汉字识别，需要准备规模庞大的数据集。仅仅是常见的汉字数据集，就有高达七千多种类别，且汉字书法风格迥异，若要训练出泛化性强，准确度高的神经网络模型，就需要足够充分复杂的数据集，数据集即要体现出汉字的普遍特征，也要具备不同的形式风格，通过数据集也可以预料到需要足够强大的模型才能实现对任意手写汉字的识别。</p>
<p>例如，常见手写汉字识别数据集的下载：</p>
<p><a target="_blank" rel="noopener" href="https://drive.google.com/file/d/1k849yUZhkUfbupZT0kRR2ZzZj5g89yLw/view?usp=sharing">汉字名为类别标签的手写数据集</a> (747M)</p>
<p>文件结构如下：</p>
<p>├── data<br>
│   ├── chinese-calligraphy-dataset<br>
│   │   ├── ㄚ<br>
│   │   ├── 一<br>
│   │   ├── 丁<br>
│   │   ├── 七<br>
│   │   ├── 万<br>
│   │   └── …<br>
│   └── label_character.csv</p>
<h2 id="2编写tensorflow工具链与使用说明"><a class="markdownIt-Anchor" href="#2编写tensorflow工具链与使用说明"></a> 2.编写Tensorflow工具链与使用说明</h2>
<p>准备好数据集后，我们首先要做的工作是对数据集进行处理，使其符合神经网络模型训练的规范格式，其次，也有一些通过程序的方法能够对原始数据集进行处理，增加数据集的多样性，我们使用的方法为“数据增强”，即在原始数据集的基础上，对每张图片进行小幅度旋转，对比度调节，平移，压缩，放大等操作，这样有利于提高最后训练的模型的泛化性。</p>
<p>注意：代码运行需要在在命令行的<mark>本例：tf_gpu_1</mark>的环境中运行</p>
<h3 id="21数据集划分脚本"><a class="markdownIt-Anchor" href="#21数据集划分脚本"></a> 2.1<strong>数据集划分脚本</strong></h3>
<p>本脚本分为三个阶段：</p>
<p>1.将原始数据集复制到指定目录，并且分为test,val,train，即测试集，验证集，训练集。</p>
<p>2.对分类后的数据集进行数据增强，每张图片生成5张增强后的图像，那么，数据集的复杂程度得到了一定的增加</p>
<p>3.检查测试集中是否存在空的子文件夹，由于有些类别的汉字图片可能较少，按照代码中：20%的比例从训练集划分给测试集，若测试集图片少于2张，可能导致测试集中该类别没有对应的图片，所以，这个阶段用于对测试集文件夹进行二次排查，确保测试集中不存在空的汉字类别图片。</p>
<p><mark>使用方法：</mark></p>
<p>修改</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src_data_folder = <span class="string">"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/CursiveChineseCalligraphyDataset-master/Cursive_Chinese_Calligraphy_Dataset/Training"</span>  <span class="comment"># todo 修改你的原始数据集路径</span></span><br><span class="line">target_data_folder = <span class="string">"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu"</span>  <span class="comment"># </span></span><br></pre></td></tr></tbody></table></figure>
<p>其中src_data_folder为原始数据集路径，target_data_folder为划分好的目标路径(将包含train,val,test三个子文件夹)</p>
<p>在tf_gpu_1环境下，输入命令 python data_split.py</p>
<p><strong>完整代码(data_split.py)如下：</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> shutil <span class="keyword">import</span> copy2, move</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageEnhance</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">copy_file</span>(<span class="params">src_dest</span>):</span><br><span class="line">    src_img_path, target_folder = src_dest</span><br><span class="line">    copy2(src_img_path, target_folder)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_file</span>(<span class="params">src_dest</span>):</span><br><span class="line">    src_img_path, target_folder = src_dest</span><br><span class="line">    move(src_img_path, target_folder)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">augment_image</span>(<span class="params">src_img_path, target_folder, num_augments=<span class="number">5</span></span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(src_img_path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_augments):</span><br><span class="line">        img_aug = img.copy()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机旋转</span></span><br><span class="line">        angle = random.uniform(-<span class="number">15</span>, <span class="number">15</span>)  <span class="comment"># -15到15度之间的随机旋转</span></span><br><span class="line">        img_aug = img_aug.rotate(angle, fillcolor=<span class="string">'white'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机平移</span></span><br><span class="line">        max_translate = <span class="number">5</span>  <span class="comment"># 最大平移像素值</span></span><br><span class="line">        x_translate = random.randint(-max_translate, -max_translate)</span><br><span class="line">        y_translate = random.randint(-max_translate, -max_translate)</span><br><span class="line">        img_aug = img_aug.transform(img_aug.size, Image.AFFINE, (<span class="number">1</span>, <span class="number">0</span>, x_translate, <span class="number">0</span>, <span class="number">1</span>, y_translate),</span><br><span class="line">                                    fillcolor=<span class="string">'white'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机缩放</span></span><br><span class="line">        scale_factor = random.uniform(<span class="number">0.9</span>, <span class="number">1.1</span>)</span><br><span class="line">        w, h = img_aug.size</span><br><span class="line">        img_aug = img_aug.resize((<span class="built_in">int</span>(w * scale_factor), <span class="built_in">int</span>(h * scale_factor)), Image.Resampling.LANCZOS)</span><br><span class="line">        img_aug = img_aug.resize((w, h), Image.Resampling.LANCZOS)  <span class="comment"># 重新调整为原始尺寸</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机对比度调整</span></span><br><span class="line">        enhancer = ImageEnhance.Contrast(img_aug)</span><br><span class="line">        img_aug = enhancer.enhance(random.uniform(<span class="number">0.8</span>, <span class="number">1.2</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 随机亮度调整</span></span><br><span class="line">        enhancer = ImageEnhance.Brightness(img_aug)</span><br><span class="line">        img_aug = enhancer.enhance(random.uniform(<span class="number">0.8</span>, <span class="number">1.2</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 保存增强后的图像</span></span><br><span class="line">        aug_img_name = os.path.basename(src_img_path).replace(<span class="string">"."</span>, <span class="string">f"_aug_<span class="subst">{i}</span>."</span>)</span><br><span class="line">        img_aug.save(os.path.join(target_folder, aug_img_name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_set_split_and_augment</span>(<span class="params">src_data_folder, target_data_folder, train_scale=<span class="number">0.8</span>, val_scale=<span class="number">0.2</span>, test_scale=<span class="number">0.0</span>,</span></span><br><span class="line"><span class="params">                               num_augments=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    读取源数据文件夹，生成划分好的文件夹，并对每张图片生成5张增强图片。</span></span><br><span class="line"><span class="string">    :param src_data_folder: 源文件夹</span></span><br><span class="line"><span class="string">    :param target_data_folder: 目标文件夹</span></span><br><span class="line"><span class="string">    :param train_scale: 训练集比例</span></span><br><span class="line"><span class="string">    :param val_scale: 验证集比例</span></span><br><span class="line"><span class="string">    :param test_scale: 测试集比例</span></span><br><span class="line"><span class="string">    :param num_augments: 每张图片生成的增强图片数量</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    class_names = os.listdir(src_data_folder)</span><br><span class="line">    split_names = [<span class="string">'train'</span>, <span class="string">'val'</span>, <span class="string">'test'</span>]</span><br><span class="line">    data_split_completed = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查目标文件夹是否已存在文件，如果存在则跳过数据集划分</span></span><br><span class="line">    <span class="keyword">for</span> split_name <span class="keyword">in</span> split_names:</span><br><span class="line">        split_path = os.path.join(target_data_folder, split_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(split_path) <span class="keyword">or</span> <span class="built_in">len</span>(os.listdir(split_path)) == <span class="number">0</span>:</span><br><span class="line">            data_split_completed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data_split_completed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始数据集划分"</span>)</span><br><span class="line">        <span class="comment"># 在目标目录下创建文件夹</span></span><br><span class="line">        <span class="keyword">for</span> split_name <span class="keyword">in</span> split_names:</span><br><span class="line">            split_path = os.path.join(target_data_folder, split_name)</span><br><span class="line">            os.makedirs(split_path, exist_ok=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># 在split_path的目录下创建类别文件夹</span></span><br><span class="line">            <span class="keyword">for</span> class_name <span class="keyword">in</span> class_names:</span><br><span class="line">                class_split_path = os.path.join(split_path, class_name)</span><br><span class="line">                os.makedirs(class_split_path, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        tasks = []</span><br><span class="line">        total_files = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算总文件数并生成任务列表</span></span><br><span class="line">        <span class="keyword">for</span> class_name <span class="keyword">in</span> class_names:</span><br><span class="line">            current_class_data_path = os.path.join(src_data_folder, class_name)</span><br><span class="line">            current_all_data = os.listdir(current_class_data_path)</span><br><span class="line">            total_files += <span class="built_in">len</span>(current_all_data)</span><br><span class="line"></span><br><span class="line">            random.shuffle(current_all_data)</span><br><span class="line"></span><br><span class="line">            train_folder = os.path.join(os.path.join(target_data_folder, <span class="string">'train'</span>), class_name)</span><br><span class="line">            val_folder = os.path.join(os.path.join(target_data_folder, <span class="string">'val'</span>), class_name)</span><br><span class="line">            test_folder = os.path.join(os.path.join(target_data_folder, <span class="string">'test'</span>), class_name)</span><br><span class="line"></span><br><span class="line">            train_stop_flag = <span class="built_in">len</span>(current_all_data) * train_scale</span><br><span class="line">            val_stop_flag = <span class="built_in">len</span>(current_all_data) * (train_scale + val_scale)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> idx, img_name <span class="keyword">in</span> <span class="built_in">enumerate</span>(current_all_data):</span><br><span class="line">                src_img_path = os.path.join(current_class_data_path, img_name)</span><br><span class="line">                <span class="keyword">if</span> idx &lt;= train_stop_flag:</span><br><span class="line">                    tasks.append((src_img_path, train_folder))</span><br><span class="line">                <span class="keyword">elif</span> idx &lt;= val_stop_flag:</span><br><span class="line">                    tasks.append((src_img_path, val_folder))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    tasks.append((src_img_path, test_folder))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用多线程进行复制，并显示进度条</span></span><br><span class="line">        <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">8</span>) <span class="keyword">as</span> executor:</span><br><span class="line">            <span class="built_in">list</span>(tqdm(executor.<span class="built_in">map</span>(copy_file, tasks), total=total_files, desc=<span class="string">"文件复制进度"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"数据集划分完成！"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"数据集划分已经完成，跳过该步骤。"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第二阶段：数据增强</span></span><br><span class="line">    data_augmentation_completed = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> class_name <span class="keyword">in</span> class_names:</span><br><span class="line">        train_class_folder = os.path.join(target_data_folder, <span class="string">'train'</span>, class_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">any</span>(<span class="string">"_aug_"</span> <span class="keyword">in</span> fname <span class="keyword">for</span> fname <span class="keyword">in</span> os.listdir(train_class_folder)):</span><br><span class="line">            data_augmentation_completed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data_augmentation_completed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"开始数据增强"</span>)</span><br><span class="line">        aug_tasks = []</span><br><span class="line">        <span class="keyword">for</span> split_name <span class="keyword">in</span> split_names:</span><br><span class="line">            split_folder = os.path.join(target_data_folder, split_name)</span><br><span class="line">            <span class="keyword">for</span> class_name <span class="keyword">in</span> class_names:</span><br><span class="line">                class_split_folder = os.path.join(split_folder, class_name)</span><br><span class="line">                <span class="keyword">for</span> img_name <span class="keyword">in</span> os.listdir(class_split_folder):</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">"_aug_"</span> <span class="keyword">in</span> img_name:  <span class="comment"># 检查是否已经增强过</span></span><br><span class="line">                        src_img_path = os.path.join(class_split_folder, img_name)</span><br><span class="line">                        aug_tasks.append((src_img_path, class_split_folder, num_augments))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">8</span>) <span class="keyword">as</span> executor:</span><br><span class="line">            <span class="built_in">list</span>(tqdm(executor.<span class="built_in">map</span>(<span class="keyword">lambda</span> x: augment_image(*x), aug_tasks), total=<span class="built_in">len</span>(aug_tasks), desc=<span class="string">"数据增强进度"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"数据增强完成！"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"数据增强已经完成，跳过该步骤。"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第三阶段：检查并补充val文件夹中的内容</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"开始检查并补充val文件夹"</span>)</span><br><span class="line">    supplement_tasks = []</span><br><span class="line">    <span class="keyword">for</span> class_name <span class="keyword">in</span> class_names:</span><br><span class="line">        val_class_folder = os.path.join(target_data_folder, <span class="string">'val'</span>, class_name)</span><br><span class="line">        train_class_folder = os.path.join(target_data_folder, <span class="string">'train'</span>, class_name)</span><br><span class="line"></span><br><span class="line">        val_files = os.listdir(val_class_folder)</span><br><span class="line">        train_files = os.listdir(train_class_folder)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(val_files) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(val_files) &lt; <span class="built_in">len</span>(train_files) * <span class="number">0.1</span>:</span><br><span class="line">            num_to_move = <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(<span class="built_in">len</span>(train_files) * <span class="number">0.1</span>))</span><br><span class="line">            random.shuffle(train_files)</span><br><span class="line">            files_to_move = train_files[:num_to_move]</span><br><span class="line">            <span class="keyword">for</span> file_name <span class="keyword">in</span> files_to_move:</span><br><span class="line">                src_img_path = os.path.join(train_class_folder, file_name)</span><br><span class="line">                supplement_tasks.append((src_img_path, val_class_folder))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">8</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="built_in">list</span>(tqdm(executor.<span class="built_in">map</span>(move_file, supplement_tasks), total=<span class="built_in">len</span>(supplement_tasks), desc=<span class="string">"补充val文件夹进度"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"val文件夹补充完成！"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    src_data_folder = <span class="string">"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/CursiveChineseCalligraphyDataset-master/Cursive_Chinese_Calligraphy_Dataset/Training"</span>  <span class="comment"># todo 修改你的原始数据集路径</span></span><br><span class="line">    target_data_folder = <span class="string">"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu"</span>  <span class="comment"># todo 修改为你要存放的路径</span></span><br><span class="line">    data_set_split_and_augment(src_data_folder, target_data_folder, num_augments=<span class="number">5</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="22数据集标签的提取"><a class="markdownIt-Anchor" href="#22数据集标签的提取"></a> 2.2数据集标签的提取</h3>
<p>此例汉字识别的类别高达7318种，并且为中文的格式，手动定义数据集的标签显然不太现实，因此，需要编写一个能够提取数据集标签的脚本。</p>
<p>使用方法：</p>
<p>在tf_gpu_1环境下使用命令 python labels_get.py运行此代码，将在代码相同目录下生成标签文件</p>
<p><strong>完整代码(labels_get)如下</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据集加载函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_chinese_dataset</span>(<span class="params">data_dir</span>):</span><br><span class="line">    <span class="comment"># 使用 pathlib 处理路径</span></span><br><span class="line">    data_dir = Path(data_dir).resolve()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载数据集，获取类别标签和图像数据</span></span><br><span class="line">    dataset = tf.keras.preprocessing.image_dataset_from_directory(</span><br><span class="line">        <span class="built_in">str</span>(data_dir),</span><br><span class="line">        label_mode=<span class="string">'int'</span>,  <span class="comment"># 使用整数标签</span></span><br><span class="line">        seed=<span class="number">123</span>,</span><br><span class="line">        batch_size=<span class="number">32</span>,  <span class="comment"># 根据内存大小调整批量大小</span></span><br><span class="line">        image_size=(<span class="number">256</span>, <span class="number">256</span>)  <span class="comment"># 根据需要调整图像大小</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取类别标签</span></span><br><span class="line">    class_names = dataset.class_names</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印类别标签</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"类别标签（中文）："</span>, class_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存标签到 Python 文件</span></span><br><span class="line">    labels_file_path = Path(data_dir).parent / <span class="string">"lables_caoshu.py"</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(labels_file_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(<span class="string">"labels_caoshu = [\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> label <span class="keyword">in</span> class_names:</span><br><span class="line">            file.write(<span class="string">f"    '<span class="subst">{label}</span>',\n"</span>)</span><br><span class="line">        file.write(<span class="string">"]\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"标签已保存到 <span class="subst">{labels_file_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回数据集和标签</span></span><br><span class="line">    <span class="keyword">return</span> dataset, class_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：使用指定路径加载汉字数据集</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    data_dir = <span class="string">r"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu/train"</span></span><br><span class="line">    dataset, chinese_labels = load_chinese_dataset(data_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印一些样本数据</span></span><br><span class="line">    <span class="keyword">for</span> images, labels <span class="keyword">in</span> dataset.take(<span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"图像批次："</span>, images.numpy())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"标签批次："</span>, labels.numpy())</span><br></pre></td></tr></tbody></table></figure>
<h3 id="23模型的训练"><a class="markdownIt-Anchor" href="#23模型的训练"></a> 2.3模型的训练</h3>
<h4 id="231基于卷积神经网络cnn的模型训练"><a class="markdownIt-Anchor" href="#231基于卷积神经网络cnn的模型训练"></a> 2.3.1基于卷积神经网络(CNN)的模型训练</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量以确保使用 UTF-8 编码</span></span><br><span class="line">os.environ[<span class="string">'PYTHONIOENCODING'</span>] = <span class="string">'utf-8'</span></span><br><span class="line">os.environ[<span class="string">'LANG'</span>] = <span class="string">'zh_CN.UTF-8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据集加载函数，指明数据集的位置并统一处理为imgheight*imgwidth的大小，同时设置batch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_load</span>(<span class="params">data_dir, test_data_dir, img_height, img_width, batch_size</span>):</span><br><span class="line">    <span class="comment"># 使用 pathlib 处理路径</span></span><br><span class="line">    data_dir = Path(data_dir).resolve()</span><br><span class="line">    test_data_dir = Path(test_data_dir).resolve()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载训练集</span></span><br><span class="line">    train_ds = tf.keras.preprocessing.image_dataset_from_directory(</span><br><span class="line">        <span class="built_in">str</span>(data_dir),</span><br><span class="line">        label_mode=<span class="string">'categorical'</span>,</span><br><span class="line">        seed=<span class="number">123</span>,</span><br><span class="line">        image_size=(img_height, img_width),</span><br><span class="line">        batch_size=batch_size)</span><br><span class="line">    <span class="comment"># 加载测试集</span></span><br><span class="line">    val_ds = tf.keras.preprocessing.image_dataset_from_directory(</span><br><span class="line">        <span class="built_in">str</span>(test_data_dir),</span><br><span class="line">        label_mode=<span class="string">'categorical'</span>,</span><br><span class="line">        seed=<span class="number">123</span>,</span><br><span class="line">        image_size=(img_height, img_width),</span><br><span class="line">        batch_size=batch_size)</span><br><span class="line">    class_names = train_ds.class_names</span><br><span class="line">    <span class="comment"># 返回处理之后的训练集、验证集和类名</span></span><br><span class="line">    <span class="keyword">return</span> train_ds, val_ds, class_names</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建CNN模型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model_load</span>(<span class="params">IMG_SHAPE=(<span class="params"><span class="number">160</span>, <span class="number">160</span>, <span class="number">3</span></span>), class_num=<span class="number">12</span></span>):</span><br><span class="line">    <span class="comment"># 搭建模型</span></span><br><span class="line">    model = tf.keras.models.Sequential([</span><br><span class="line">        <span class="comment"># 对模型做归一化的处理，将0-255之间的数字统一处理到0到1之间</span></span><br><span class="line">        <span class="comment"># 使用 Lambda 层代替 Rescaling 层以兼容旧版本 TensorFlow</span></span><br><span class="line">        tf.keras.layers.Lambda(<span class="keyword">lambda</span> x: x / <span class="number">255.0</span>, input_shape=IMG_SHAPE),</span><br><span class="line">        <span class="comment"># 卷积层，该卷积层的输出为32个通道，卷积核的大小是3*3，激活函数为relu</span></span><br><span class="line">        tf.keras.layers.Conv2D(<span class="number">32</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">'relu'</span>),</span><br><span class="line">        <span class="comment"># 添加池化层，池化的kernel大小是2*2</span></span><br><span class="line">        tf.keras.layers.MaxPooling2D(<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">        <span class="comment"># Add another convolution</span></span><br><span class="line">        <span class="comment"># 卷积层，输出为64个通道，卷积核大小为3*3，激活函数为relu</span></span><br><span class="line">        tf.keras.layers.Conv2D(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">'relu'</span>),</span><br><span class="line">        <span class="comment"># 池化层，最大池化，对2*2的区域进行池化操作</span></span><br><span class="line">        tf.keras.layers.MaxPooling2D(<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">        <span class="comment"># 将二维的输出转化为一维</span></span><br><span class="line">        tf.keras.layers.Flatten(),</span><br><span class="line">        <span class="comment"># 和卷积前的例子一样，这里使用了 128 个全连接层和 10 个输出层</span></span><br><span class="line">        tf.keras.layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>),</span><br><span class="line">        <span class="comment"># 通过softmax函数将模型输出为类名长度的神经元上，激活函数采用softmax对应概率值</span></span><br><span class="line">        tf.keras.layers.Dense(class_num, activation=<span class="string">'softmax'</span>)</span><br><span class="line">    ])</span><br><span class="line">    <span class="comment"># 输出模型信息</span></span><br><span class="line">    model.summary()</span><br><span class="line">    <span class="comment"># 指明模型的训练参数，优化器为sgd优化器，损失函数为交叉熵损失函数</span></span><br><span class="line">    model.<span class="built_in">compile</span>(optimizer=<span class="string">'sgd'</span>, loss=<span class="string">'categorical_crossentropy'</span>, metrics=[<span class="string">'accuracy'</span>])</span><br><span class="line">    <span class="comment"># 返回模型</span></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示训练过程的曲线</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_loss_acc</span>(<span class="params">history</span>):</span><br><span class="line">    <span class="comment"># 从history中提取模型训练集和验证集准确率信息和误差信息</span></span><br><span class="line">    acc = history.history[<span class="string">'accuracy'</span>]</span><br><span class="line">    val_acc = history.history[<span class="string">'val_accuracy'</span>]</span><br><span class="line">    loss = history.history[<span class="string">'loss'</span>]</span><br><span class="line">    val_loss = history.history[<span class="string">'val_loss'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按照上下结构将图画输出</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    plt.plot(acc, label=<span class="string">'Training Accuracy'</span>)</span><br><span class="line">    plt.plot(val_acc, label=<span class="string">'Validation Accuracy'</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Accuracy'</span>)</span><br><span class="line">    plt.ylim([<span class="built_in">min</span>(plt.ylim()), <span class="number">1</span>])</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Accuracy'</span>)</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    plt.plot(loss, label=<span class="string">'Training Loss'</span>)</span><br><span class="line">    plt.plot(val_loss, label=<span class="string">'Validation Loss'</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper right'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Cross Entropy'</span>)</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Loss'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'epoch'</span>)</span><br><span class="line">    plt.savefig(<span class="string">'results/results_cnn.png'</span>, dpi=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">epochs</span>):</span><br><span class="line">    <span class="comment"># 开始训练，记录开始时间</span></span><br><span class="line">    begin_time = time()</span><br><span class="line">    <span class="comment"># 加载数据集， 修改为你的数据集的路径</span></span><br><span class="line">    train_ds, val_ds, class_names = data_load(</span><br><span class="line">        <span class="string">r"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-all-more/train"</span>,</span><br><span class="line">        <span class="string">r"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-all-more/val"</span>,</span><br><span class="line">        <span class="number">160</span>, <span class="number">160</span>, <span class="number">32</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"类别标签（中文）："</span>, class_names)</span><br><span class="line">    <span class="comment"># 加载模型</span></span><br><span class="line">    model = model_load(class_num=<span class="built_in">len</span>(class_names))</span><br><span class="line">    <span class="comment"># 指明训练的轮数epoch，开始训练</span></span><br><span class="line">    history = model.fit(train_ds, validation_data=val_ds, epochs=epochs)</span><br><span class="line">    <span class="comment"># 保存模型， 修改为你要保存的模型的名称</span></span><br><span class="line">    model.save(<span class="string">"models/cnn_hanzi_2.h5"</span>)</span><br><span class="line">    <span class="comment"># 记录结束时间</span></span><br><span class="line">    end_time = time()</span><br><span class="line">    run_time = end_time - begin_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'该循环程序运行时间：'</span>, run_time, <span class="string">"s"</span>)  <span class="comment"># 该循环程序运行时间： 1.4201874732</span></span><br><span class="line">    <span class="comment"># 绘制模型训练过程图</span></span><br><span class="line">    show_loss_acc(history)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    train(epochs=<span class="number">40</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="232基于残差神经网络resnet的模型训练"><a class="markdownIt-Anchor" href="#232基于残差神经网络resnet的模型训练"></a> <strong>2.3.2基于残差神经网络(Resnet)的模型训练</strong></h4>
<p>汉字识别模型类别非常多，使用一般的神经网络训练出来的模型可能泛化性并不理想，针对多类别的模型训练可以采用更复杂的网络，比如本例的Resnet残差神经网络，最终训练的模型准确率和泛化性极高。</p>
<p><mark>使用方法：</mark></p>
<p>代码片段中，修改路径为已经划分好的训练集，测试集路径</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train_ds, val_ds, class_names = data_load(</span><br><span class="line">    <span class="string">r"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu/train"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">r"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu/val"</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">128</span>, <span class="number">64</span>)  <span class="comment"># 减小批处理大小</span></span><br></pre></td></tr></tbody></table></figure>
<p>模型保存名称修改</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.save(<span class="string">"models/final_resnet50_chinese_kai"</span>, save_format=<span class="string">'tf'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>在tf_gpu_1环境下，使用命令 python model_train_resnet50.py</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量以确保使用 UTF-8 编码</span></span><br><span class="line">os.environ[<span class="string">'PYTHONIOENCODING'</span>] = <span class="string">'utf-8'</span></span><br><span class="line">os.environ[<span class="string">'LANG'</span>] = <span class="string">'zh_CN.UTF-8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用混合精度训练</span></span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.mixed_precision <span class="keyword">import</span> experimental <span class="keyword">as</span> mixed_precision</span><br><span class="line">policy = mixed_precision.Policy(<span class="string">'mixed_float16'</span>)</span><br><span class="line">mixed_precision.set_policy(policy)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据加载函数，加入数据增强</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_load</span>(<span class="params">data_dir, test_data_dir, img_height, img_width, batch_size</span>):</span><br><span class="line">    data_dir = Path(data_dir).resolve()</span><br><span class="line">    test_data_dir = Path(test_data_dir).resolve()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载训练集</span></span><br><span class="line">    train_ds = tf.keras.preprocessing.image_dataset_from_directory(</span><br><span class="line">        <span class="built_in">str</span>(data_dir),</span><br><span class="line">        label_mode=<span class="string">'categorical'</span>,</span><br><span class="line">        seed=<span class="number">123</span>,</span><br><span class="line">        image_size=(img_height, img_width),</span><br><span class="line">        batch_size=batch_size</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取类别标签</span></span><br><span class="line">    class_names = train_ds.class_names</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据增强</span></span><br><span class="line">    data_augmentation = tf.keras.Sequential([</span><br><span class="line">        tf.keras.layers.experimental.preprocessing.RandomFlip(<span class="string">'horizontal'</span>),</span><br><span class="line">        tf.keras.layers.experimental.preprocessing.RandomRotation(<span class="number">0.1</span>),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加入数据增强</span></span><br><span class="line">    train_ds = train_ds.<span class="built_in">map</span>(<span class="keyword">lambda</span> x, y: (data_augmentation(x), y), num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载测试集</span></span><br><span class="line">    val_ds = tf.keras.preprocessing.image_dataset_from_directory(</span><br><span class="line">        <span class="built_in">str</span>(test_data_dir),</span><br><span class="line">        label_mode=<span class="string">'categorical'</span>,</span><br><span class="line">        seed=<span class="number">123</span>,</span><br><span class="line">        image_size=(img_height, img_width),</span><br><span class="line">        batch_size=batch_size</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预取数据</span></span><br><span class="line">    train_ds = train_ds.prefetch(buffer_size=tf.data.experimental.AUTOTUNE)</span><br><span class="line">    val_ds = val_ds.prefetch(buffer_size=tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> train_ds, val_ds, class_names</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建ResNet模型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model_load</span>(<span class="params">IMG_SHAPE=(<span class="params"><span class="number">128</span>, <span class="number">128</span>, <span class="number">3</span></span>), class_num=<span class="number">7200</span></span>):</span><br><span class="line">    resnet = tf.keras.applications.ResNet50(weights=<span class="string">'imagenet'</span>, include_top=<span class="literal">False</span>, input_shape=IMG_SHAPE)</span><br><span class="line"></span><br><span class="line">    model = tf.keras.models.Sequential([</span><br><span class="line">        resnet,</span><br><span class="line">        tf.keras.layers.GlobalAveragePooling2D(),</span><br><span class="line">        tf.keras.layers.Dense(<span class="number">1024</span>, activation=<span class="string">'relu'</span>),</span><br><span class="line">        tf.keras.layers.Dropout(<span class="number">0.5</span>),</span><br><span class="line">        tf.keras.layers.Dense(class_num, activation=<span class="string">'softmax'</span>)</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    model.summary()</span><br><span class="line"></span><br><span class="line">    initial_learning_rate = <span class="number">0.01</span></span><br><span class="line">    lr_schedule = tf.keras.optimizers.schedules.ExponentialDecay(</span><br><span class="line">        initial_learning_rate, decay_steps=<span class="number">10000</span>, decay_rate=<span class="number">0.9</span>, staircase=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    optimizer = tf.keras.optimizers.SGD(learning_rate=lr_schedule, momentum=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line">    model.<span class="built_in">compile</span>(optimizer=optimizer,</span><br><span class="line">                  loss=<span class="string">'categorical_crossentropy'</span>,</span><br><span class="line">                  metrics=[<span class="string">'accuracy'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示训练过程的曲线</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_loss_acc</span>(<span class="params">history</span>):</span><br><span class="line">    acc = history.history[<span class="string">'accuracy'</span>]</span><br><span class="line">    val_acc = history.history[<span class="string">'val_accuracy'</span>]</span><br><span class="line">    loss = history.history[<span class="string">'loss'</span>]</span><br><span class="line">    val_loss = history.history[<span class="string">'val_loss'</span>]</span><br><span class="line"></span><br><span class="line">    plt.figure(figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    plt.plot(acc, label=<span class="string">'Training Accuracy'</span>)</span><br><span class="line">    plt.plot(val_acc, label=<span class="string">'Validation Accuracy'</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'lower right'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Accuracy'</span>)</span><br><span class="line">    plt.ylim([<span class="built_in">min</span>(plt.ylim()), <span class="number">1</span>])</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Accuracy'</span>)</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    plt.plot(loss, label=<span class="string">'Training Loss'</span>)</span><br><span class="line">    plt.plot(val_loss, label=<span class="string">'Validation Loss'</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">'upper right'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'Cross Entropy'</span>)</span><br><span class="line">    plt.title(<span class="string">'Training and Validation Loss'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'epoch'</span>)</span><br><span class="line">    plt.savefig(<span class="string">'results/results_resnet.png'</span>, dpi=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加早停和模型检查点回调</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">epochs</span>):</span><br><span class="line">    begin_time = time()</span><br><span class="line"></span><br><span class="line">    train_ds, val_ds, class_names = data_load(</span><br><span class="line">        <span class="string">r"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu/train"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">r"s:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-caoshu/val"</span>,</span><br><span class="line">        <span class="number">128</span>, <span class="number">128</span>, <span class="number">64</span>)  <span class="comment"># 减小批处理大小</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"类别标签（中文）："</span>, class_names)</span><br><span class="line"></span><br><span class="line">    model = model_load(class_num=<span class="built_in">len</span>(class_names))</span><br><span class="line"></span><br><span class="line">    early_stopping = tf.keras.callbacks.EarlyStopping(</span><br><span class="line">        monitor=<span class="string">'val_loss'</span>, patience=<span class="number">10</span>, restore_best_weights=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    checkpoint = tf.keras.callbacks.ModelCheckpoint(</span><br><span class="line">        <span class="string">'models/final_resnet50_chinese_kai'</span>, monitor=<span class="string">'val_loss'</span>, save_best_only=<span class="literal">True</span>, save_format=<span class="string">'tf'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    history = model.fit(</span><br><span class="line">        train_ds, validation_data=val_ds, epochs=epochs,</span><br><span class="line">        callbacks=[early_stopping, checkpoint]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    model.save(<span class="string">"models/final_resnet50_chinese_kai"</span>, save_format=<span class="string">'tf'</span>)</span><br><span class="line"></span><br><span class="line">    end_time = time()</span><br><span class="line">    run_time = end_time - begin_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'该循环程序运行时间：'</span>, run_time, <span class="string">"s"</span>)</span><br><span class="line"></span><br><span class="line">    show_loss_acc(history)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    train(epochs=<span class="number">15</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="24-模型的测试"><a class="markdownIt-Anchor" href="#24-模型的测试"></a> 2.4 模型的测试</h3>
<p>代码如下，更改测试集以及模型路径为相应的目标路径即可</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Matplotlib显示中文</span></span><br><span class="line">plt.rcParams[<span class="string">'font.family'</span>] = [<span class="string">'sans-serif'</span>]</span><br><span class="line">plt.rcParams[<span class="string">'font.sans-serif'</span>] = [<span class="string">'SimHei'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据加载</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data_load</span>(<span class="params">data_dir, test_data_dir, img_height, img_width, batch_size</span>):</span><br><span class="line">    class_names = <span class="built_in">sorted</span>(</span><br><span class="line">        [dir_name <span class="keyword">for</span> dir_name <span class="keyword">in</span> os.listdir(data_dir) <span class="keyword">if</span> os.path.isdir(os.path.join(data_dir, dir_name))])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Detected <span class="subst">{<span class="built_in">len</span>(class_names)}</span> classes."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_path</span>(<span class="params">file_path</span>):</span><br><span class="line">        label = tf.strings.split(file_path, os.path.sep)[-<span class="number">2</span>]</span><br><span class="line">        label = tf.where(tf.equal(tf.constant(class_names), label))[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        img = tf.io.read_file(file_path)</span><br><span class="line">        img = tf.image.decode_jpeg(img, channels=<span class="number">3</span>)</span><br><span class="line">        img = tf.image.resize(img, [img_height, img_width])</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prepare_dataset</span>(<span class="params">directory</span>):</span><br><span class="line">        list_ds = tf.data.Dataset.list_files(os.path.join(directory, <span class="string">'*/*'</span>), shuffle=<span class="literal">True</span>)</span><br><span class="line">        labeled_ds = list_ds.<span class="built_in">map</span>(process_path, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">        labeled_ds = labeled_ds.batch(batch_size).prefetch(buffer_size=tf.data.experimental.AUTOTUNE)</span><br><span class="line">        <span class="keyword">return</span> labeled_ds</span><br><span class="line"></span><br><span class="line">    train_ds = prepare_dataset(data_dir)</span><br><span class="line">    val_ds = prepare_dataset(test_data_dir)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Loaded datasets: <span class="subst">{<span class="built_in">len</span>(train_ds)}</span> training batches, <span class="subst">{<span class="built_in">len</span>(val_ds)}</span> validation batches."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> train_ds, val_ds, class_names</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 聚合类别并随机抽取10个类别生成热力图</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aggregate_labels_and_select</span>(<span class="params">real_labels, pred_labels, num_classes, num_groups, selected_groups</span>):</span><br><span class="line">    group_size = num_classes // num_groups</span><br><span class="line">    real_labels_agg = [label // group_size <span class="keyword">for</span> label <span class="keyword">in</span> real_labels]</span><br><span class="line">    pred_labels_agg = [label // group_size <span class="keyword">for</span> label <span class="keyword">in</span> pred_labels]</span><br><span class="line"></span><br><span class="line">    real_labels_selected = [real_labels_agg[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(real_labels_agg)) <span class="keyword">if</span></span><br><span class="line">                            real_labels_agg[i] <span class="keyword">in</span> selected_groups]</span><br><span class="line">    pred_labels_selected = [pred_labels_agg[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pred_labels_agg)) <span class="keyword">if</span></span><br><span class="line">                            real_labels_agg[i] <span class="keyword">in</span> selected_groups]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> real_labels_selected, pred_labels_selected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试cnn模型准确率</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_cnn</span>():</span><br><span class="line">    <span class="comment"># 加载数据</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    train_ds, test_ds, class_names = data_load(</span><br><span class="line">        <span class="string">r"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-all/train"</span>,</span><br><span class="line">        <span class="string">r"S:/2_tensflow_Project/chinese-calligraphy-dataset-master/data/data-chinese-all/val"</span>,</span><br><span class="line">        <span class="number">160</span>, <span class="number">160</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Data loading completed in <span class="subst">{time.time() - start_time:<span class="number">.2</span>f}</span> seconds."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载模型</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    model = tf.keras.models.load_model(<span class="string">"models/final_resnet50_chinese"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Model loaded in <span class="subst">{time.time() - start_time:<span class="number">.2</span>f}</span> seconds."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 编译模型</span></span><br><span class="line">    model.<span class="built_in">compile</span>(optimizer=<span class="string">'adam'</span>, loss=<span class="string">'sparse_categorical_crossentropy'</span>, metrics=[<span class="string">'accuracy'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 推理</span></span><br><span class="line">    test_real_labels = []</span><br><span class="line">    test_pre_labels = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Starting model inference..."</span>)</span><br><span class="line">    inference_start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> batch_idx, (test_batch_images, test_batch_labels) <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_ds):</span><br><span class="line">        <span class="keyword">if</span> batch_idx &gt;= <span class="number">10</span>:  <span class="comment"># 只处理前10个batch来加速测试</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> batch_idx % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"Processing batch <span class="subst">{batch_idx + <span class="number">1</span>}</span>..."</span>)</span><br><span class="line">        test_batch_labels = test_batch_labels.numpy()</span><br><span class="line">        test_batch_pres = model.predict(test_batch_images)</span><br><span class="line"></span><br><span class="line">        test_real_labels.extend(test_batch_labels)</span><br><span class="line">        test_pre_labels.extend(np.argmax(test_batch_pres, axis=<span class="number">1</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Inference completed in <span class="subst">{time.time() - inference_start_time:<span class="number">.2</span>f}</span> seconds."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 聚合类别并随机抽取10个类别</span></span><br><span class="line">    num_groups = <span class="number">10</span></span><br><span class="line">    selected_groups = random.sample(<span class="built_in">range</span>(num_groups), <span class="number">10</span>)</span><br><span class="line">    test_real_labels_agg, test_pre_labels_agg = aggregate_labels_and_select(</span><br><span class="line">        test_real_labels, test_pre_labels, <span class="built_in">len</span>(class_names), num_groups, selected_groups</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成聚合后的热力图</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Generating aggregated heatmaps..."</span>)</span><br><span class="line">    heat_maps = np.zeros((num_groups, num_groups))</span><br><span class="line">    <span class="keyword">for</span> real_label, pred_label <span class="keyword">in</span> <span class="built_in">zip</span>(test_real_labels_agg, test_pre_labels_agg):</span><br><span class="line">        heat_maps[real_label][pred_label] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    heat_maps_sum = np.<span class="built_in">sum</span>(heat_maps, axis=<span class="number">1</span>).reshape(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    heat_maps_sum[heat_maps_sum == <span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    heat_maps_float = heat_maps / heat_maps_sum</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建存储热力图的文件夹</span></span><br><span class="line">    output_dir = <span class="string">"results/aggregated_heatmap"</span></span><br><span class="line">    os.makedirs(output_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存聚合热力图</span></span><br><span class="line">    save_path = os.path.join(output_dir, <span class="string">"aggregated_heatmap.png"</span>)</span><br><span class="line">    show_heatmaps(<span class="string">"Aggregated Heatmap"</span>, selected_groups, selected_groups,</span><br><span class="line">                  heat_maps_float[selected_groups][:, selected_groups], save_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Saved aggregated heatmap to <span class="subst">{save_path}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"All heatmaps generated and saved."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_heatmaps</span>(<span class="params">title, x_labels, y_labels, harvest, save_name</span>):</span><br><span class="line">    <span class="comment"># 创建画布</span></span><br><span class="line">    fig, ax = plt.subplots()</span><br><span class="line">    im = ax.imshow(harvest, cmap=<span class="string">"OrRd"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改标签</span></span><br><span class="line">    ax.set_xticks(np.arange(<span class="built_in">len</span>(y_labels)))</span><br><span class="line">    ax.set_yticks(np.arange(<span class="built_in">len</span>(x_labels)))</span><br><span class="line">    ax.set_xticklabels(y_labels)</span><br><span class="line">    ax.set_yticklabels(x_labels)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 旋转x轴标签</span></span><br><span class="line">    plt.setp(ax.get_xticklabels(), rotation=<span class="number">45</span>, ha=<span class="string">"right"</span>, rotation_mode=<span class="string">"anchor"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加每个热力块的具体数值</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x_labels)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(y_labels)):</span><br><span class="line">            ax.text(j, i, <span class="built_in">round</span>(harvest[i, j], <span class="number">2</span>), ha=<span class="string">"center"</span>, va=<span class="string">"center"</span>, color=<span class="string">"black"</span>)</span><br><span class="line"></span><br><span class="line">    ax.set_xlabel(<span class="string">"Predict label"</span>)</span><br><span class="line">    ax.set_ylabel(<span class="string">"Actual label"</span>)</span><br><span class="line">    ax.set_title(title)</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    plt.colorbar(im)</span><br><span class="line">    plt.savefig(save_name, dpi=<span class="number">100</span>)</span><br><span class="line">    plt.close(fig)  <span class="comment"># 关闭图形以释放内存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    test_cnn()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Total execution time: <span class="subst">{time.time() - start_time:<span class="number">.2</span>f}</span> seconds."</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="25-tensorboard工具模型流图"><a class="markdownIt-Anchor" href="#25-tensorboard工具模型流图"></a> 2.5 tensorboard工具——模型流图</h3>
<p>model = tf.saved_model.load(“models/final_resnet50_chinese”) 语句中修改为目标模型</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设你已经加载了你的模型</span></span><br><span class="line">model = tf.saved_model.load(<span class="string">"models/final_resnet50_chinese"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取模型的推理签名（与导出的模型相关，可能需要调整具体签名名称）</span></span><br><span class="line">infer = model.signatures[<span class="string">'serving_default'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 TensorBoard 日志目录</span></span><br><span class="line">log_dir = <span class="string">"logs/graph"</span></span><br><span class="line">writer = tf.summary.create_file_writer(log_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个包装函数并使用 tf.function</span></span><br><span class="line"><span class="meta">@tf.function</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model_inference</span>(<span class="params">input_tensor</span>):</span><br><span class="line">    <span class="keyword">return</span> infer(input_tensor)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个示例输入张量（调整形状以匹配模型的输入要求）</span></span><br><span class="line">example_input = tf.random.normal([<span class="number">1</span>, <span class="number">160</span>, <span class="number">160</span>, <span class="number">3</span>])  <span class="comment"># 假设模型输入是160x160x3的图像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录数据流图</span></span><br><span class="line"><span class="keyword">with</span> writer.as_default():</span><br><span class="line">    <span class="comment"># 开启追踪</span></span><br><span class="line">    tf.summary.trace_on(graph=<span class="literal">True</span>, profiler=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行一次推理以记录计算图</span></span><br><span class="line">    model_inference(example_input)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 记录计算图</span></span><br><span class="line">    tf.summary.trace_export(name=<span class="string">"model_trace"</span>, step=<span class="number">0</span>, profiler_outdir=log_dir)</span><br><span class="line"></span><br><span class="line">    writer.flush()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Graph has been written to TensorBoard logs. You can view it using TensorBoard."</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="26-模型的使用"><a class="markdownIt-Anchor" href="#26-模型的使用"></a> 2.6 模型的使用</h2>
<p>本例为基于Qt界面的汉字识别程序，通过加载训练好的Tensorflow模型，选择本地的图片作为输入，进行手写汉字识别</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2021/6/17 20:29</span></span><br><span class="line"><span class="comment"># @Author  : dejahu</span></span><br><span class="line"><span class="comment"># @Email   : 1148392984@qq.com</span></span><br><span class="line"><span class="comment"># @File    : window.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="comment"># @Brief   : 图形化界面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> lables_caoshu <span class="keyword">import</span> labels_caoshu</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainWindow</span>(<span class="title class_ inherited__">QTabWidget</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.setWindowIcon(QIcon(<span class="string">'images/logo.png'</span>))</span><br><span class="line">        self.setWindowTitle(<span class="string">'CNN汉字识别系统'</span>)</span><br><span class="line">        self.model = tf.keras.models.load_model(<span class="string">"models/final_resnet50_chinese"</span>)</span><br><span class="line">        self.to_predict_name = <span class="string">"images/Start_1.png"</span></span><br><span class="line">        self.class_names = labels_caoshu</span><br><span class="line">        self.resize(<span class="number">900</span>, <span class="number">700</span>)</span><br><span class="line">        self.initUI()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initUI</span>(<span class="params">self</span>):</span><br><span class="line">        main_widget = QWidget()</span><br><span class="line">        main_layout = QHBoxLayout()</span><br><span class="line">        font = QFont(<span class="string">'楷体'</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">        dark_style = <span class="string">"""</span></span><br><span class="line"><span class="string">            QWidget {</span></span><br><span class="line"><span class="string">                background-color: #2E2E2E;</span></span><br><span class="line"><span class="string">                color: #FFFFFF;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QLabel {</span></span><br><span class="line"><span class="string">                color: #FFFFFF;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QPushButton {</span></span><br><span class="line"><span class="string">                background-color: #4F4F4F;</span></span><br><span class="line"><span class="string">                border: 2px solid #6E6E6E;</span></span><br><span class="line"><span class="string">                color: #FFFFFF;</span></span><br><span class="line"><span class="string">                padding: 5px;</span></span><br><span class="line"><span class="string">                border-radius: 5px;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QPushButton:hover {</span></span><br><span class="line"><span class="string">                background-color: #6E6E6E;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QPushButton:pressed {</span></span><br><span class="line"><span class="string">                background-color: #3D3D3D;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QTabBar::tab {</span></span><br><span class="line"><span class="string">                background: #3D3D3D;</span></span><br><span class="line"><span class="string">                color: #FFFFFF;</span></span><br><span class="line"><span class="string">                padding: 10px;</span></span><br><span class="line"><span class="string">                border-radius: 5px;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QTabBar::tab:selected {</span></span><br><span class="line"><span class="string">                background: #2E2E2E;</span></span><br><span class="line"><span class="string">                border-bottom: 2px solid #4F4F4F;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">            QTabBar::tab:!selected {</span></span><br><span class="line"><span class="string">                background: #3D3D3D;</span></span><br><span class="line"><span class="string">            }</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.setStyleSheet(dark_style)</span><br><span class="line"></span><br><span class="line">        left_widget = QWidget()</span><br><span class="line">        left_layout = QVBoxLayout()</span><br><span class="line">        img_title = QLabel(<span class="string">"输入作品"</span>)</span><br><span class="line">        img_title.setFont(font)</span><br><span class="line">        img_title.setAlignment(Qt.AlignCenter)</span><br><span class="line">        self.img_label = QLabel()</span><br><span class="line">        self.process_image(self.to_predict_name)</span><br><span class="line">        self.img_label.setPixmap(QPixmap(<span class="string">"images/binary_show.png"</span>))</span><br><span class="line">        left_layout.addWidget(img_title)</span><br><span class="line">        left_layout.addWidget(self.img_label, <span class="number">1</span>, Qt.AlignCenter)</span><br><span class="line">        left_widget.setLayout(left_layout)</span><br><span class="line"></span><br><span class="line">        right_widget = QWidget()</span><br><span class="line">        right_layout = QVBoxLayout()</span><br><span class="line">        btn_change = QPushButton(<span class="string">" 上传作品 "</span>)</span><br><span class="line">        btn_change.setIcon(QIcon(<span class="string">'images/upload.png'</span>))</span><br><span class="line">        btn_change.clicked.connect(self.change_img)</span><br><span class="line">        btn_change.setFont(font)</span><br><span class="line">        btn_predict = QPushButton(<span class="string">" 开始识别 "</span>)</span><br><span class="line">        btn_predict.setIcon(QIcon(<span class="string">'images/recognize.png'</span>))</span><br><span class="line">        btn_predict.setFont(font)</span><br><span class="line">        btn_predict.clicked.connect(self.predict_img)</span><br><span class="line">        label_result = QLabel(<span class="string">' 识别结果 '</span>)</span><br><span class="line">        self.result = QLabel(<span class="string">"等待识别"</span>)</span><br><span class="line">        label_result.setFont(QFont(<span class="string">'楷体'</span>, <span class="number">16</span>))</span><br><span class="line">        self.result.setFont(QFont(<span class="string">'楷体'</span>, <span class="number">24</span>))</span><br><span class="line">        right_layout.addStretch()</span><br><span class="line">        right_layout.addWidget(label_result, <span class="number">0</span>, Qt.AlignCenter)</span><br><span class="line">        right_layout.addStretch()</span><br><span class="line">        right_layout.addWidget(self.result, <span class="number">0</span>, Qt.AlignCenter)</span><br><span class="line">        right_layout.addStretch()</span><br><span class="line">        right_layout.addStretch()</span><br><span class="line">        right_layout.addWidget(btn_change)</span><br><span class="line">        right_layout.addWidget(btn_predict)</span><br><span class="line">        right_layout.addStretch()</span><br><span class="line">        right_widget.setLayout(right_layout)</span><br><span class="line"></span><br><span class="line">        main_layout.addWidget(left_widget)</span><br><span class="line">        main_layout.addWidget(right_widget)</span><br><span class="line">        main_widget.setLayout(main_layout)</span><br><span class="line"></span><br><span class="line">        about_widget = QWidget()</span><br><span class="line">        about_layout = QVBoxLayout()</span><br><span class="line">        about_title = QLabel(<span class="string">'欢迎使用手写汉字识别系统'</span>)</span><br><span class="line">        about_title.setFont(QFont(<span class="string">'楷体'</span>, <span class="number">18</span>))</span><br><span class="line">        about_title.setAlignment(Qt.AlignCenter)</span><br><span class="line">        about_img = QLabel()</span><br><span class="line">        about_img.setPixmap(QPixmap(<span class="string">'images/CNN.png'</span>))</span><br><span class="line">        about_img.setAlignment(Qt.AlignCenter)</span><br><span class="line">        label_super = QLabel(<span class="string">"sz_jmu"</span>)</span><br><span class="line">        label_super.setFont(QFont(<span class="string">'楷体'</span>, <span class="number">12</span>))</span><br><span class="line">        label_super.setAlignment(Qt.AlignRight)</span><br><span class="line">        about_layout.addWidget(about_title)</span><br><span class="line">        about_layout.addStretch()</span><br><span class="line">        about_layout.addWidget(about_img)</span><br><span class="line">        about_layout.addStretch()</span><br><span class="line">        about_layout.addWidget(label_super)</span><br><span class="line">        about_widget.setLayout(about_layout)</span><br><span class="line"></span><br><span class="line">        self.addTab(main_widget, <span class="string">'主页'</span>)</span><br><span class="line">        self.addTab(about_widget, <span class="string">'关于'</span>)</span><br><span class="line">        self.setTabIcon(<span class="number">0</span>, QIcon(<span class="string">'images/主页面.png'</span>))</span><br><span class="line">        self.setTabIcon(<span class="number">1</span>, QIcon(<span class="string">'images/关于.png'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传并显示图片</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">change_img</span>(<span class="params">self</span>):</span><br><span class="line">        openfile_name = QFileDialog.getOpenFileName(self, <span class="string">'chose files'</span>, <span class="string">''</span>,</span><br><span class="line">                                                    <span class="string">'Image files(*.jpg *.png *jpeg)'</span>)  <span class="comment"># 打开文件选择框选择文件</span></span><br><span class="line">        img_name = openfile_name[<span class="number">0</span>]  <span class="comment"># 获取图片名称</span></span><br><span class="line">        <span class="keyword">if</span> img_name == <span class="string">''</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            target_image_name = <span class="string">"images/tmp_up."</span> + img_name.split(<span class="string">"."</span>)[-<span class="number">1</span>]  <span class="comment"># 将图片移动到当前目录</span></span><br><span class="line">            shutil.copy(img_name, target_image_name)</span><br><span class="line">            self.to_predict_name = target_image_name</span><br><span class="line">            self.process_image(self.to_predict_name)</span><br><span class="line">            self.img_label.setPixmap(QPixmap(<span class="string">"images/binary_show.png"</span>))  <span class="comment"># 显示二值化后的图片</span></span><br><span class="line">            self.result.setText(<span class="string">"等待识别"</span>)</span><br><span class="line">            self.show_binary_image()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 图片处理和二值化</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">self, image_path</span>):</span><br><span class="line">        img_init = cv2.imread(image_path)  <span class="comment"># 打开图片</span></span><br><span class="line">        h, w, c = img_init.shape</span><br><span class="line">        scale = <span class="number">400</span> / h</span><br><span class="line">        img_show = cv2.resize(img_init, (<span class="number">0</span>, <span class="number">0</span>), fx=scale, fy=scale)  <span class="comment"># 将图片的大小统一调整到400的高，方便界面显示</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 二值化处理</span></span><br><span class="line">        gray_img = cv2.cvtColor(img_init, cv2.COLOR_BGR2GRAY)</span><br><span class="line">        _, binary_img = cv2.threshold(gray_img, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line">        binary_img_inverted = cv2.bitwise_not(binary_img)</span><br><span class="line">        binary_img_colored = cv2.cvtColor(binary_img_inverted, cv2.COLOR_GRAY2BGR)</span><br><span class="line">        binary_img_show = cv2.resize(binary_img_colored, (<span class="number">0</span>, <span class="number">0</span>), fx=scale, fy=scale)  <span class="comment"># 将二值化图像调整到400高显示</span></span><br><span class="line"></span><br><span class="line">        cv2.imwrite(<span class="string">'images/binary_show.png'</span>, binary_img_show)  <span class="comment"># 保存显示用的二值化图片</span></span><br><span class="line">        cv2.imwrite(<span class="string">'images/target.png'</span>, binary_img_colored)  <span class="comment"># 保存用于识别的二值化图片</span></span><br><span class="line">        cv2.imwrite(<span class="string">'images/binary_target.png'</span>, binary_img)  <span class="comment"># 保存仅用于二值化显示的图像</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预测图片</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_img</span>(<span class="params">self</span>):</span><br><span class="line">        img = Image.<span class="built_in">open</span>(<span class="string">'images/target.png'</span>)  <span class="comment"># 读取二值化图片</span></span><br><span class="line">        img = img.resize((<span class="number">128</span>, <span class="number">128</span>))  <span class="comment"># 调整图像大小到模型所需的输入尺寸</span></span><br><span class="line">        img = np.asarray(img)  <span class="comment"># 将图片转化为numpy的数组</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 确保图像是3个通道的</span></span><br><span class="line">        <span class="keyword">if</span> img.shape[-<span class="number">1</span>] != <span class="number">3</span>:</span><br><span class="line">            img = cv2.cvtColor(img, cv2.COLOR_GRAY2RGB)</span><br><span class="line"></span><br><span class="line">        img = img.reshape(<span class="number">1</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">3</span>)  <span class="comment"># 调整图像的形状以匹配模型输入</span></span><br><span class="line">        outputs = self.model.predict(img)  <span class="comment"># 将图片输入模型得到结果</span></span><br><span class="line">        result_index = <span class="built_in">int</span>(np.argmax(outputs))</span><br><span class="line">        result = self.class_names[result_index]  <span class="comment"># 获得对应的识别结果</span></span><br><span class="line">        self.result.setText(result)  <span class="comment"># 在界面上显示结果</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示二值化图片</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">show_binary_image</span>(<span class="params">self</span>):</span><br><span class="line">        binary_image_window = QMainWindow()</span><br><span class="line">        binary_image_window.setWindowTitle(<span class="string">'二值化处理结果'</span>)</span><br><span class="line">        binary_image_widget = QLabel()</span><br><span class="line">        binary_image = QPixmap(<span class="string">"images/binary_target.png"</span>)</span><br><span class="line">        binary_image_widget.setPixmap(binary_image)</span><br><span class="line">        binary_image_widget.setAlignment(Qt.AlignCenter)</span><br><span class="line">        binary_image_window.setCentralWidget(binary_image_widget)</span><br><span class="line">        binary_image_window.resize(binary_image.size())</span><br><span class="line">        binary_image_window.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 界面关闭事件，询问用户是否关闭</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">closeEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        reply = QMessageBox.question(self,</span><br><span class="line">                                     <span class="string">'退出'</span>,</span><br><span class="line">                                     <span class="string">"是否要退出程序？"</span>,</span><br><span class="line">                                     QMessageBox.Yes | QMessageBox.No,</span><br><span class="line">                                     QMessageBox.No)</span><br><span class="line">        <span class="keyword">if</span> reply == QMessageBox.Yes:</span><br><span class="line">            self.close()</span><br><span class="line">            event.accept()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            event.ignore()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    x = MainWindow()</span><br><span class="line">    x.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></tbody></table></figure>
<p><strong>运行结果如下：</strong></p>

<p>tensorflow_gpu_tools工具链总结：</p>
<ul>
<li>
<p>data_split.py：数据集划分脚本</p>
</li>
<li>
<p>labels_get.py：标签生成脚本</p>
</li>
<li>
<p>model_train_resnet50.py：训练脚本</p>
</li>
<li>
<p>tf_board.py：模型结构/流图展示脚本</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="http://window.py">window.py</a>：模型识别QT程序</p>
</li>
</ul>
<h1 id="更新记录"><a class="markdownIt-Anchor" href="#更新记录"></a> 更新记录</h1>
<p>此栏目用于记录代码项目新增功能，bug修复等日志</p>
<blockquote>
<p>date:2024.8.29</p>
<p>对<strong>model_train_densenet169.py</strong> 新增<strong>参数接口化</strong>配置，使用<strong>命令行</strong>即可便捷配置模型训练参数</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse                          <span class="comment"># 导入argparse模块以处理命令行参数</span></span><br></pre></td></tr></tbody></table></figure>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="/posts/33676/image-20240830003108581.png" class="" title="image-20240830003108581">
<p>如：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python script_name.py --train_data_dir <span class="string">"path/to/train_data"</span> --test_data_dir <span class="string">"path/to/test_data"</span> --img_height <span class="number">128</span> --img_width <span class="number">128</span> --batch_size <span class="number">64</span> --epochs <span class="number">15</span></span><br></pre></td></tr></tbody></table></figure>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://szturin.github.io">Szturin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://szturin.github.io/posts/33676/">https://szturin.github.io/posts/33676/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://szturin.github.io" target="_blank">Turin's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://api.aqcoder.cn/random" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9067/" title="【stm32单片机】[Hal库][2]stm32时钟树"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【stm32单片机】[Hal库][2]stm32时钟树</div></div></a></div><div class="next-post pull-right"><a href="/posts/9383/" title="【TI】[2]常见外设的基本配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【TI】[2]常见外设的基本配置</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Szturin</div><div class="author-info__description">保持热爱，奔赴星海</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Szturin"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">近期学习：1.stm32裸机开发-->rtos 2.python->OpenMv</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-tensorflow%E7%8E%AF%E5%A2%83%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text"> 一、Tensorflow环境的基本配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-%E6%89%8B%E5%86%99%E6%B1%89%E5%AD%97%E8%AF%86%E5%88%AB%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">3.</span> <span class="toc-text"> 二、手写汉字识别神经网络模型训练</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text"> 1.数据集的准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E7%BC%96%E5%86%99tensorflow%E5%B7%A5%E5%85%B7%E9%93%BE%E4%B8%8E%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">3.2.</span> <span class="toc-text"> 2.编写Tensorflow工具链与使用说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21%E6%95%B0%E6%8D%AE%E9%9B%86%E5%88%92%E5%88%86%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 2.1数据集划分脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22%E6%95%B0%E6%8D%AE%E9%9B%86%E6%A0%87%E7%AD%BE%E7%9A%84%E6%8F%90%E5%8F%96"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 2.2数据集标签的提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%AE%AD%E7%BB%83"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 2.3模型的训练</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#231%E5%9F%BA%E4%BA%8E%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9Ccnn%E7%9A%84%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">3.2.3.1.</span> <span class="toc-text"> 2.3.1基于卷积神经网络(CNN)的模型训练</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#232%E5%9F%BA%E4%BA%8E%E6%AE%8B%E5%B7%AE%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9Cresnet%E7%9A%84%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">3.2.3.2.</span> <span class="toc-text"> 2.3.2基于残差神经网络(Resnet)的模型训练</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.4.</span> <span class="toc-text"> 2.4 模型的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-tensorboard%E5%B7%A5%E5%85%B7%E6%A8%A1%E5%9E%8B%E6%B5%81%E5%9B%BE"><span class="toc-number">3.2.5.</span> <span class="toc-text"> 2.5 tensorboard工具——模型流图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text"> 2.6 模型的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">4.</span> <span class="toc-text"> 更新记录</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/56683/" title="【stm32单片机】[Hal库][3]嵌入式工程模板与“任务调度器”"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【stm32单片机】[Hal库][3]嵌入式工程模板与“任务调度器”"/></a><div class="content"><a class="title" href="/posts/56683/" title="【stm32单片机】[Hal库][3]嵌入式工程模板与“任务调度器”">【stm32单片机】[Hal库][3]嵌入式工程模板与“任务调度器”</a><time datetime="2024-09-09T14:35:16.000Z" title="发表于 2024-09-09 22:35:16">2024-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/34487/" title="【Tensorflow】[2] 神经网络搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Tensorflow】[2] 神经网络搭建"/></a><div class="content"><a class="title" href="/posts/34487/" title="【Tensorflow】[2] 神经网络搭建">【Tensorflow】[2] 神经网络搭建</a><time datetime="2024-09-07T17:12:30.000Z" title="发表于 2024-09-08 01:12:30">2024-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/46726/" title="【Python基础】[1]Python的基本语法"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Python基础】[1]Python的基本语法"/></a><div class="content"><a class="title" href="/posts/46726/" title="【Python基础】[1]Python的基本语法">【Python基础】[1]Python的基本语法</a><time datetime="2024-09-05T04:58:08.000Z" title="发表于 2024-09-05 12:58:08">2024-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7213/" title="【Git学习】[3]标签管理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Git学习】[3]标签管理"/></a><div class="content"><a class="title" href="/posts/7213/" title="【Git学习】[3]标签管理">【Git学习】[3]标签管理</a><time datetime="2024-09-03T11:02:08.000Z" title="发表于 2024-09-03 19:02:08">2024-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/21302/" title="【Git学习】[2]分支管理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://api.aqcoder.cn/random" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Git学习】[2]分支管理"/></a><div class="content"><a class="title" href="/posts/21302/" title="【Git学习】[2]分支管理">【Git学习】[2]分支管理</a><time datetime="2024-09-03T10:38:38.000Z" title="发表于 2024-09-03 18:38:38">2024-09-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Szturin</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script id="click-heart" src="https://unpkg.com/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站采用多线程部署，主线路托管于腾讯云服务器，备用线路托管于Github/Gitee。" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/loading.gif" data-original="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body></html>